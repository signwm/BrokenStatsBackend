<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Instancje</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <style>
        .card-container{display:flex;gap:10px;overflow-x:auto;}
        .day-card{min-width:250px;background:#1e1e1e;border-radius:8px;padding:10px;}
        .day-card ul{list-style:none;padding:0;margin:0;}
        .day-card li{border-bottom:1px solid #333;padding:4px 0;}
        .day-card li:last-child{border-bottom:none;}
    </style>
</head>
<body class="bg-dark text-light container py-3">
    <div class="d-flex justify-content-between mb-2">
        <h1>Instancje</h1>
        <button id="todayBtn" class="btn btn-secondary">Dzisiaj</button>
    </div>
    <div id="cards" class="card-container"></div>
    <script>
    const selKey = 'inst_selected_day';
    const cardsEl = document.getElementById('cards');
    let selected = localStorage.getItem(selKey);
    async function load(){
        const days = await (await fetch('/api/instances/days')).json();
        const today = new Date().toISOString().split('T')[0];
        if(!selected) selected = today;
        const all = await Promise.all(days.map(async d => {
            const list = await (await fetch('/api/instances/byDay?date='+d.date)).json();
            const details = await Promise.all(list.map(async inst => {
                const fights = await (await fetch('/api/instances/'+inst.id+'/fights')).json();
                const gold = fights.reduce((a,f)=>a+f.gold,0);
                const exp = fights.reduce((a,f)=>a+f.exp,0);
                const psycho = fights.reduce((a,f)=>a+f.psycho,0);
                const drop = fights.reduce((a,f)=>a+f.dropValue,0);
                const dur = inst.endTime? (new Date(inst.endTime)-new Date(inst.startTime))/1000:0;
                return {name:inst.name,difficulty:inst.difficulty,gold,exp,psycho,profit:gold+drop,duration:dur};
            }));
            return {date:d.date,details};
        }));
        cardsEl.innerHTML='';
        all.forEach(day=>{
            const card=document.createElement('div');
            card.className='day-card';
            card.id='card-'+day.date;
            card.innerHTML=`<h5>${day.date}</h5>`;
            const ul=document.createElement('ul');
            day.details.forEach(i=>{
                const diff=i.difficulty===2?'Ł':i.difficulty===1?'N':'T';
                const dur=Math.floor(i.duration/60)+':'+'0'.repeat(2).slice(-(i.duration%60).toString().length)+(i.duration%60);
                const li=document.createElement('li');
                li.textContent=`${i.name} [${diff}] ${dur} | ${i.gold}g | ${i.exp} exp | ${i.psycho} psy | ${i.profit}g`;
                ul.appendChild(li);
            });
            card.appendChild(ul);
            cardsEl.appendChild(card);
        });
        moveTo(selected);
    }
    function moveTo(day){
        const el=document.getElementById('card-'+day);
        if(el){cardsEl.scrollLeft=el.offsetLeft; selected=day; localStorage.setItem(selKey,day);} }
    document.getElementById('todayBtn').addEventListener('click',()=>moveTo(new Date().toISOString().split('T')[0]));
    load();
    </script>
</body>
</html>
