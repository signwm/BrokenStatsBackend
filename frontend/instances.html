<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Instancje</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-dark text-light">
    <h1 class="mb-3">Instancje</h1>
    <div class="instances-layout">
        <ul id="dayList" class="day-list"></ul>
        <ul id="instanceList" class="instance-list"></ul>
        <table id="fightsTable" class="custom-dark-table">
            <thead>
                <tr>
                    <th scope="col">Czas</th>
                    <th scope="col">Exp</th>
                    <th scope="col">Gold</th>
                    <th scope="col">Psycho</th>
                    <th scope="col">Przeciwnicy</th>
                    <th scope="col">Łupy</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
<script>
let selectedDay = localStorage.getItem('selectedDay');
let selectedInstance = localStorage.getItem('selectedInstance');

function pad(n){return n.toString().padStart(2,'0');}
function formatDate(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
function formatMMSS(sec){const m=Math.floor(sec/60);const s=sec%60;return `${pad(m)}:${pad(s)}`;}

async function loadDays(){
    const days = await (await fetch('/api/instances/days')).json();
    if(!selectedDay){ selectedDay = days[0].date; }
    renderDayList(days);
}

function renderDayList(days){
    const ul=document.getElementById('dayList');
    ul.innerHTML='';
    days.forEach(d=>{
        const li=document.createElement('li');
        li.textContent=`${d.date} (${d.count})`;
        li.dataset.date=d.date;
        if(d.date===selectedDay) li.classList.add('selected');
        li.addEventListener('click',()=>{ selectedDay=d.date; localStorage.setItem('selectedDay',selectedDay); loadInstances(); renderDayList(days); });
        ul.appendChild(li);
    });
}

async function loadInstances(){
    const res = await fetch('/api/instances/byDay?date='+selectedDay);
    const list = await res.json();
    renderInstanceList(list);
}

function renderInstanceList(list){
    const ul=document.getElementById('instanceList');
    ul.innerHTML='';
    const none=document.createElement('li');
    none.textContent='Bez instancji';
    none.dataset.id='none';
    if(!selectedInstance) selectedInstance='none';
    if(selectedInstance==='none') none.classList.add('selected');
    none.addEventListener('click',()=>{selectedInstance='none'; localStorage.setItem('selectedInstance',selectedInstance); loadFights(); renderInstanceList(list);});
    ul.appendChild(none);
    let defaultSet=false;
    list.forEach(inst=>{
        const diffChar = inst.difficulty===2?'Ł':inst.difficulty===1?'N':'T';
        let time='trwa';
        if(inst.endTime) {
            const sec=Math.floor((new Date(inst.endTime)-new Date(inst.startTime))/1000);
            time=formatMMSS(sec);
        }
        const li=document.createElement('li');
        li.textContent=`${inst.name} [${diffChar}] (${time})`;
        li.dataset.id=inst.id;
        if(!selectedInstance && !defaultSet && !inst.endTime){selectedInstance=inst.id.toString();defaultSet=true;}
        if(inst.id.toString()===selectedInstance) li.classList.add('selected');
        li.addEventListener('click',()=>{selectedInstance=inst.id.toString(); localStorage.setItem('selectedInstance',selectedInstance); loadFights(); renderInstanceList(list);});
        ul.appendChild(li);
    });
    localStorage.setItem('selectedInstance',selectedInstance);
    loadFights();
}

async function loadFights(){
    const tbody=document.querySelector('#fightsTable tbody');
    tbody.innerHTML='';
    if(selectedInstance==='none'){
        const fights=await (await fetch('/api/instances/without/fights')).json();
        fights.forEach(f=>{
            const tr=document.createElement('tr');
            const t=new Date(f.time);
            const time=`${pad(t.getDate())}.${pad(t.getMonth()+1)} ${pad(t.getHours())}:${pad(t.getMinutes())}:${pad(t.getSeconds())}`;
            tr.innerHTML=`<td>${time}</td><td>${f.exp}</td><td>${f.gold}</td><td>${f.psycho}</td><td>${f.opponents}</td><td>${f.drops}</td>`;
            tbody.appendChild(tr);
        });
    }else{
        const fights=await (await fetch('/api/instances/'+selectedInstance+'/fights')).json();
        fights.forEach(f=>{
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${formatMMSS(f.offsetSeconds)}</td><td>${f.exp}</td><td>${f.gold}</td><td>${f.psycho}</td><td>${f.opponents}</td><td>${f.drops}</td>`;
            tbody.appendChild(tr);
        });
    }
}

function refresh(){loadDays().then(loadInstances);}
refresh();
setInterval(refresh,10000);
</script>
</body>
</html>
