<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="style2.css">
  <style>
    body{display:flex;flex-direction:column;align-items:center;gap:20px;}
    .controls{display:flex;gap:10px;margin-bottom:10px;}
    #details{width:100%;}
  </style>
</head>
<body>
  <div class="controls">
    <label id="startLabel">Start: <input type="datetime-local" id="start"></label>
    <label id="endLabel">Koniec: <input type="datetime-local" id="end"></label>
    <button id="backBtn" class="back-button" style="display:none;">Powrót</button>
  </div>
  <div id="instances"></div>
  <div id="details" style="display:none;">
    <div id="detailSummary" class="summary-widget"></div>
    <div id="fights"></div>
  </div>
<script>
const startInput=document.getElementById('start');
const endInput=document.getElementById('end');
const startLabel=document.getElementById('startLabel');
const endLabel=document.getElementById('endLabel');
const backBtn=document.getElementById('backBtn');
const instancesDiv=document.getElementById('instances');
const detailsDiv=document.getElementById('details');
const summaryDiv=document.getElementById('detailSummary');
const fightsDiv=document.getElementById('fights');
let instanceStarts={};
function pad(n){return n.toString().padStart(2,'0');}
function formatDate(dt){return `${pad(dt.getDate())}.${pad(dt.getMonth()+1)} ${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;}
function formatDuration(sec){const h=Math.floor(sec/3600);const m=Math.floor((sec%3600)/60);const s=sec%60;return `${pad(h)}:${pad(m)}:${pad(s)}`;}
function loadInstances(){
  const from=startInput.value;const to=endInput.value;
  if(!from||!to)return;
  fetch(`/api/instances/range?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`)
    .then(r=>r.json()).then(showInstances);
}
function showInstances(list){
  instancesDiv.innerHTML='';
  instanceStarts={};
  const table=document.createElement('table');
  table.className='custom-dark-table';
  table.innerHTML=`<thead><tr><th>Data startu</th><th>Nazwa</th><th>Trudność</th><th>Złoto</th><th>Exp</th><th>Psycho</th><th>Zarobek</th><th>Walki</th><th>Czas trwania</th></tr></thead>`;
  const tbody=document.createElement('tbody');
  list.forEach(inst=>{
    instanceStarts[inst.id]=inst.startTime;
    const diff=inst.difficulty===2?'Ł':inst.difficulty===1?'N':'T';
    const tr=document.createElement('tr');
    const dur=inst.durationSeconds!=null?formatDuration(inst.durationSeconds):`<button data-id="${inst.id}" class="close end-button">zakończ instancję</button>`;
    tr.innerHTML=`<td>${formatDate(new Date(inst.startTime))}</td><td>${inst.name}</td><td>${diff}</td><td>${inst.gold.toLocaleString()}</td><td>${inst.exp.toLocaleString()}</td><td>${inst.psycho.toLocaleString()}</td><td>${inst.profit.toLocaleString()}</td><td>${inst.fights}</td><td>${dur}</td>`;
    tr.dataset.id=inst.id;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  instancesDiv.appendChild(table);
  tbody.querySelectorAll('button.close').forEach(btn=>btn.addEventListener('click',e=>{e.stopPropagation();closeInstance(btn.dataset.id);}));
  tbody.querySelectorAll('tr').forEach(tr=>tr.addEventListener('click',e=>{if(e.target.tagName==='BUTTON')return;showDetails(tr.dataset.id);}));
}
function closeInstance(id){
  fetch(`/api/instances/${id}/close`,{method:'POST'}).then(()=>loadInstances());
}
function showDetails(id){
  const start=instanceStarts[id];
  if(!start)return;
  fetch(`/api/instances/${id}/fights`).then(r=>r.json()).then(list=>{
    const ids=list.map(f=>f.id);
    fetch('/api/fights/summary',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(ids)})
      .then(r=>r.json()).then(s=>renderSummary(s));
    const table=document.createElement('table');
    table.className='custom-dark-table';
    table.innerHTML=`<thead><tr><th>Data</th><th>Złoto</th><th>Exp</th><th>Psycho</th><th>Przeciwnicy</th><th>Drop</th></tr></thead>`;
    const tbody=document.createElement('tbody');
    list.forEach(f=>{
      const time=new Date(new Date(start).getTime()+f.offsetSeconds*1000);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${formatDate(time)}</td><td>${f.gold}</td><td>${f.exp}</td><td>${f.psycho}</td><td>${f.opponents}</td><td>${f.drops}</td>`;
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    fightsDiv.innerHTML='';
    fightsDiv.appendChild(table);
    instancesDiv.style.display='none';
    detailsDiv.style.display='block';
    startLabel.style.display='none';
    endLabel.style.display='none';
    backBtn.style.display='inline-block';
  });
}
function renderSummary(s){
  const card=(t,v)=>`<div class="card"><h3>${t}</h3><div class="value">${v}</div></div>`;
  const drops=list=>list.map(d=>`<div class="line-item"><span class="label">${d.name}</span><span class="value">${d.count.toLocaleString()}</span></div>`).join('');
  const dropVals={};Object.entries(s.dropValuesPerType).forEach(([k,v])=>dropVals[k.toLowerCase()]=v);
  const dropCard=(t,l,v)=>`<div class="card"><h3>${t}</h3>${drops(l)}<div class="total-value">= ${v.toLocaleString()}</div></div>`;
  summaryDiv.innerHTML=`<div class="stats-row">${card('Exp',s.totalExp.toLocaleString())}${card('Psycho',s.totalPsycho.toLocaleString())}${card('Złoto',s.totalGold.toLocaleString())}${card('Zarobek',s.totalGoldWithDrops.toLocaleString())}${card('Walki',s.fightsCount.toLocaleString())}${card('Czas',formatDuration(Math.floor((new Date(s.sessionEnd)-new Date(s.sessionStart))/1000)))}</div><div class="drops-grid">${dropCard('Rary',s.rare,dropVals['rare']||0)}${dropCard('Użytkowe',s.items,dropVals['item']||0)}${dropCard('Białe',s.trash,dropVals['trash']||0)}${dropCard('Syngi',s.synergetics,dropVals['synergetic']||0)}${dropCard('Drify',s.drifs,dropVals['drif']||0)}${dropCard('Orby',[],0)}</div>`;
}
backBtn.addEventListener('click',()=>{
  detailsDiv.style.display='none';
  instancesDiv.style.display='block';
  startLabel.style.display='inline-block';
  endLabel.style.display='inline-block';
  backBtn.style.display='none';
});
const now=new Date();endInput.value=now.toISOString().slice(0,16);const start=new Date(now.getTime()-3600000);startInput.value=start.toISOString().slice(0,16);startInput.addEventListener('change',loadInstances);endInput.addEventListener('change',loadInstances);loadInstances();
</script>
</body>
</html>
